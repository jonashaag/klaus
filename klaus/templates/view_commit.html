{% extends 'base.html' %}

{% block extra_header %}{% endblock %} {# no branch selector on commits #}

{% block title %}
  Commit {{ rev }} - {{ repo.name }}
{% endblock %}

{% block content %}

<script type="text/javascript">
    function toggleelements(list){
        for (var i = 0; i < list.length; i++){
            var tmp = list[i];
            if(tmp.style.display == 'none')
                tmp.style.display = 'block';
            else
                tmp.style.display = 'none';
        }
    }

    function toggletags(id){
        var list = document.getElementsByTagName(id);
        toggleelements(list)
    }
    function toggleid(id){
        var list = new Array(document.getElementById(id));
        toggleelements(list)
    }
</script>

{% set files, adds, dels = repo.commit_diff(commit)|calc_file_stats %}
<div class=full-commit>
  {# TODO code duplication in history.html #}
  <div class=commit onclick="toggletags('table')">
    <span class=line1>
      <span>{{ commit.message|force_unicode }}</span>
    </span>
    <span class=line2>
      <span>
        {{ commit.author|force_unicode|extract_author_name }}
      </span>
      <span title="{{ commit.commit_time|formattimestamp  }}">
        {{ commit.commit_time|timesince }}
      </span>
      <span>
      {{files}} changed files with {{adds}} additions and {{dels}} deletions.
      </span>
      <span class="toggletext">Click to toggle visibility</span>
    </span>
    <span class=clearfloat></span>
  </div>

  <div class=diff>
    {% for file in repo.commit_diff(commit) %}

      {% set fileno = loop.index0 %}

      <div class=filename onclick="toggleid('file-{{fileno}}')")>
        {# TODO dulwich doesn't do rename recognition
        {% if file.old_filename != file.new_filename %}
          {{ file.old_filename }} â†’
        {% endif %}#}
          {% if file.new_filename == '/dev/null' %}
            <del>{{ file.old_filename|force_unicode }}</del>
          {% else %}
            <a href="{{ url_for('blob', repo=repo.name, rev=rev, path=file.new_filename) }}">
              {{ file.new_filename|force_unicode }}
            </a>
          {% endif %}
          <span class=additions>{{file.additions}} additions</span>
          and
          <span class=deletions>{{file.deletions}} deletions</span>
      </div>

      {% if file.chunks %}

        <table id=file-{{fileno}}>
          {% for chunk in file.chunks %}

            {%- for line in chunk -%}
              <tr>

                {#- left column: linenos -#}
                {%- if line.old_lineno -%}
                  <td class=linenos><a href="#{{fileno}}-L-{{line.old_lineno}}">{{ line.old_lineno }}</a></td>
                  {%- if line.new_lineno -%}
                    <td class=linenos><a href="#{{fileno}}-L-{{line.old_lineno}}">{{ line.new_lineno }}</a></td>
                  {%- else -%}
                    <td class=linenos></td>
                  {%- endif -%}
                {%- else %}
                  {%- if line.old_lineno -%}
                    <td class=linenos><a href="#{{fileno}}-R-{{line.old_lineno}}">{{ line.new_lineno }}</a></td>
                  {%- else -%}
                    <td class=linenos></td>
                  {%- endif -%}
                  <td class=linenos><a href="#{{fileno}}-R-{{line.new_lineno}}">{{ line.new_lineno }}</a></td>
                {% endif %}

                {#- right column: code -#}
                <td class={{line.action}}>
                  {#- lineno anchors -#}
                  {%- if line.old_lineno -%}
                    <a name="{{fileno}}-L-{{line.old_lineno}}"
                       id="{{fileno}}-L-{{line.old_lineno}}"></a>
                  {%- else -%}
                    <a name="{{fileno}}-R-{{line.new_lineno}}"
                       id="{{fileno}}-R-{{line.new_lineno}}"></a>
                  {%- endif -%}

                  {#- the actual line of code -#}
                  <span class=line>{% autoescape false %}{{ line.line|force_unicode }}{% endautoescape %}</span>
                </td>

              </tr>
            {%- endfor -%} {# lines #}

            {% if not loop.last %}
              <tr class=sep>
                <td colspan=3></td>
              </tr>
            {% endif %}

          {%- endfor -%} {# chunks #}
        </table>

      {% else %}
        <div class=binarydiff>Binary diff not shown</div>
      {% endif %}

    {% endfor %}
  </div>

</div>

<script>
  highlight_linenos({
    linksSelector: '.linenos a',
    getLineFromAnchor: function(anchor) {
      /* If we got the first (old_lineno) anchor, the span we're looking for is
         the second-next sibling, otherwise it's the next. */
      if (anchor.nextSibling instanceof HTMLSpanElement)
        return anchor.nextSibling;
      else
        return anchor.nextSibling.nextSibling;
    }
  });
</script>

{% endblock %}
